<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real World Vending Machine</title>
  <style>
    body {
      font-family: 'Confortaa', sans-serif;
      margin: 0;
    }
    .navbar {
      background-color: #333;
      overflow: hidden;
    }
    .navbar a {
      float: left;
      color: white;
      text-align: center;
      padding: 14px 16px;
      text-decoration: none;
    }
    .navbar a:hover {
      background-color: #ddd;
      color: black;
    }
    img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }
    .content {
      padding: 20px;
    }
    .image-container {
      text-align: center;
      margin: 20px 0;
    }
    .image-container img {
      max-width: 80%;
      border: 1px solid #ddd;
      padding: 5px;
      border-radius: 5px;
    }
    pre {
      background-color: #f4f4f4;
      border: 1px solid #ddd;
      padding: 10px;
      overflow-x: auto;
    }
    code {
      color: #050505;
      background-color: #f9f2f4;
      padding: 2px 4px;
      border-radius: 4px;
    }
    h1, h2, h3 {
      color: #333;
    }
    hr {
      border: 0;
      border-top: 1px solid #ddd;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div class="navbar">
    <a href="../index.html">Home</a>
    <a href="../about.html">About</a>
    <a href="../posts.html">Projects</a>
  </div>
  <div class="content">
    <h1>TEJ Traffic Light</h1>
    <p class="author"><strong>By:</strong> Sanchit Khope</p>
    <hr>
    <h2>Explanation of the Project</h2>
    <p>
      Our task for this project was to create a project using all of the skills and knowledge from the last 6 months. 
      The project we chose to make was the traffic light, using a Raspberry Pi 4b to code it. My logic behind this project was to use 
      threads, a module in Python, to run tasks concurrently. Also to use the time module to delay the LEDs in the sequence.
    </p>
    <ul>
      <li>If the pedestrian button is pressed, it starts a sequence with the pedestrian LED on, then reverts to the original sequence without the pedestrian lights.</li>
      <li>Once the pedestrian LED is on, it starts the other pedestrian light. This resembles a real stoplight.</li>
      <li>There is also a left turn signal that activates every time, resembling real-life traffic lights.</li>
      <li>It also prints the color it is on, inside the terminal, so you can also keep track of it there.</li>
    </ul>
    <p>
      This project may look simple; however, the timing of the sequences is quite complex. 
      To control the LEDs, I used <code>GPIOZero</code>, which is a simpler form of <code>RPI.GPIO</code>.
    </p>
    <hr>
    <h2>Inputs</h2>
    <p>My inputs were <strong>4 push buttons</strong> on the poles, acting as pedestrian buttons.</p>
    <hr>
    <h3>Final Image</h3>
    <img src="videos/Traffic-Light-Photo.jpg" alt="Traffic-Light-Photo" style="width: 300px; height: 380px"; float = left>
    <hr>
    <h2>Bare Circuit</h2>
    <video width="100%" height="500px" controls; float = left>
      <source src="videos/traffic_breadboard.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <hr>
    <h2>Final Working Video</h2>
    <video width="100%" height="500px" controls; float = left>
      <source src="videos/Traffic-Light-Working.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
    <hr>
    <h2>Python Code</h2>
    <pre><code>
import time
import threading
from gpiozero import LED, Button

input_received = threading.Event()
pedestrian_active = threading.Event()
normal_run_pause = threading.Event()
leftturndone = threading.Event()

led = LED(17)
gled = LED(27)
yled = LED(22)
rled = LED(23)
gled2 = LED(24)
yled2 = LED(25)
pled1 = LED(16)
pled1red = LED(26)
pled2 = LED(15)
pled2red = LED(14)
leftturn1 = LED(6)
crossbutton = Button(5)

def leftturn():
     print("Color 1: Left Turn On")
     leftturn1.on()
     time.sleep(2)
     print("Color 1: Left Turn Off")
     leftturn1.off()
     
     
def leftturngreen():
    print("\nColor: Green")
    gled.on()
    print("\nPedestrian 1: On")
    time.sleep(5)
    gled.off()
    print("Pedestrian 1: Off")

def leftturn2():
    print("Color 1: Left Turn On")
    leftturn1.on()
    time.sleep(2)
    print("Color 1: Left Turn Off")
    leftturn1.off()
    leftturndone.set()
     
     
def leftturngreen2():
    pled1red.off()
    print("\nColor: Green")
    gled.on()
   
    leftturndone.wait()
    pled1.on()
           
    print("\nPedestrian 1: On")
    time.sleep(3)
    gled.off()
    print("Pedestrian 1: Off")
    pled1.off()
    leftturndone.clear()
    pled1red.on()
   
def aftercrossing2():
    print("Color 2: Green")
    gled2.on()
    print("Color 2: Pedestrian On")
    pled2red.off()
    pled2.on()
    time.sleep(5)
    pled2.off()
    pled2red.on()
    gled2.off()
    print("Color 2: Yellow")
    yled2.on()
    time.sleep(2)
    yled2.off()
    led.off()
   
def cross_input():
    while True:
        if crossbutton.is_pressed:
            input_received.set()  # Set the event to signal input has been received)
            print("\nCrossing Signal Recieved")
           
def red_light():
    print("\nColor: Red")
    pled2.on()
    led.on()
    time.sleep(8)
    led.off()
    pled2.off()

def normalrun2():
    while True:
        pled1red.on()
        pled2red.on()
        print("\nColor 2: Red")
        rled.on()
        time.sleep(8)
        rled.off()

        # Wait if pedestrian sequence is active
        normal_run_pause.wait()

        # Skip "Color 2: Green" if pedestrian lights were just active
        if pedestrian_active.is_set():
            print("\nSkipping Color 2: Green due to pedestrian sequence")
            continue
        else:
            print("\nColor 2: Green")
            gled2.on()
            time.sleep(5)
            gled2.off()
            # Skip the green phase entirely

        print("\nColor 2: Yellow")
        yled2.on()
        time.sleep(2)
        yled2.off()
        break


def pedestrianrun2():
    while True:
        pedestrian_active.set()  # Signal pedestrian lights are active
        normal_run_pause.clear()  # Pause normalrun2
        t1_2 = threading.Thread(target=aftercrossing2, daemon=True)
        t1_3 = threading.Thread(target=leftturn2, daemon=True)
        t1_4 = threading.Thread(target=leftturngreen2, daemon=True)
        print("\Color 2: Red")
        rled.on()
        t1_4.start()
        t1_3.start()
        t1_4.join()
       
       
        print("\nColor 2: Yellow")
        yled.on()
        time.sleep(2)
        yled.off()
        rled.off()
        led.on()
       
       
        t1_2.start()
        t1_2.join()
        t1_3.join()
       
       
        break
       
   
    pedestrian_active.clear()  # Reset pedestrian active signal
    normal_run_pause.set()  # Resume normalrun2
   


def normalrun():
    while True:
        # Creating threads
        t6 = threading.Thread(target=leftturn, daemon=True)
        t5 = threading.Thread(target=leftturngreen, daemon=True)
        t4 = threading.Thread(target=pedestrianrun2, daemon=True)
        t3 = threading.Thread(target=normalrun2, daemon=True)
        t2 = threading.Thread(target=red_light, daemon=True)
        t1 = threading.Thread(target=cross_input, daemon=True)

        # Start the second traffic light thread
        normal_run_pause.set()  # Ensure normalrun2 is active initially
        t3.start()
        pled1red.on()
        pled2red.on()
        # Green light for pedestrian 1r
        t5.start()
        t6.start()
        t5.join()

        # Yellow light
        print("\nColor: Yellow")
        yled.on()
        time.sleep(2)
        yled.off()

        # Start red light and cross input threads
        t2.start()
        t1.start()

        # Wait for input with a timeout of 8 seconds
        t1.join(timeout=8)

        # Check if input was received within the timeout
        if input_received.is_set():
            print("\nActive")
            t4.start()  # Start pedestrian sequence
           
            t4.join()   # Wait for pedestrian sequence to complete
            input_received.clear()  # Reset the event
        elif t1.is_alive():
            print("\nNo")
            input_received.clear()  # Reset the event if no input was received

        # Ensure red light and second traffic light threads complete
        t2.join()
        t3.join()
        t6.join()

normalrun()
    </code></pre>
  </div>
</body>
</html>
